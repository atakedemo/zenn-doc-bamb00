---
title: "USDCでガス代を支払えるデモサイトを作った"
emoji: "🛠"
type: "tech" 
topics: ["USDC", "Account Abstraction", "Next.js"]
published: false
---


## 今回作ったデモにおける登場人物

* ユーザー＝EOA
* Bundler
* Paymaster（Circle製）
* USDCのERC20トークン（Cirle製品）

## デモの動かし方と挙動

### 1. 環境変数を設定する

.envファイルを作成する

```T
NEXT_PUBLIC_BUNDLER_PREFIX = "https://public.pimlico.io/v2/"
NEXT_PUBLIC_BASE_SEPOLIA_USDC = '0x036CbD53842c5426634e7929541eC2318f3dCF7e'
NEXT_PUBLIC_BASE_SEPOLIA_PAYMASTER = '0x31BE08D380A21fc740883c0BC434FcFc88740b58'
NEXT_PUBLIC_MAX_GAS_USDC = "1"
NEXT_PUBLIC_PRIVATEKEY = "0x..."
```

### 2. Next.jsのWeb UIを立ち上げる

```bash
npm run dev
```

### 3. Web UI上で送金を行う

以下動画のような流れとなる

1. Wallet接続
2. 送金

## どんな仕組みになっているか

Circleが用意しているPaymasterにて、スマートアカウントよりガス代分相当のUSDCを利用料として徴収している
つまり、スマートアカウントに利用料をチャージすることが事前に必要となる

Paymasterでは、"_validatePaymasterUserOp"の関数にて、トランザクション実行時における条件判定をPaymsterの運営主体で実装できる
今回のCircle製のPaymasterにおいては、この条件判定においてガス代相当のUSDC徴収が行われたといった形となる

## 実装してみての感想

### 便利だなと思った点

ハッカソンやプロジェクトに協力した際、様々なチェーンでステーブルコインをもらう。この時、メインどころのチェーンに移したい際にそもそものガス代分のネイティブトークンを用意しなければならないのだが、このガス代用意が不要となる。
よって、ステーブルコイン受け取り → 使う といった基本の動線がスムーズになる

### 考えどころだなと思った点

Paymasterが利用できるための権限を得るUIUXが頭の使い所だと感じた
今回は、スマートアカウントにUSDCを持たせる必要があったが、そもそもスマートアカウントに送金する手間が生じる。
この動線をなるべくスマートにやりたい。
ジャストアイデアではあるが、以下がパッと思いついたところ

* ガス代の代わりに用いるトークンについて、クレジットカードなどで購入させてスマートアカウントに入金する（Paypayチャージするような動線）
* 利用料無料となるためのNFTを購入してもらう
* 現金でサブスクリプション結んで、Paymaster運営側がホワイトリスト登録